# Проектная работа 8 спринта

**Ссылка на проект**: [UGC Sprint 1](https://github.com/Benrise/ugc_sprint_1)

## В спринте реализовано

- **Kafka**: Брокер сообщений Kafka с 3 нодами и Kafka-UI для управления.
- **UGC сервис**: Сервис для регистрации и обработки событийных запросов, отправка данных в Kafka.
- **UGC ETL**: Сервис ETL-процесса для получения и обработки данных из Kafka и их последующего сохранения в ClickHouse.

## Общая информация

Основные бизнес-сервисы:
- **Аутентификация** (`auth`)
- **Выдача контента** (`content`)
- **Сервис регистрации пользовательских событий** (`ugc`)
- **ETL-процессов**:
  - ETL для передачи данных из реляционной БД фильмов в `Elasticsearch` (Mock loader).
  - UGC ETL для передачи данных из Kafka в `ClickHouse`.
- **Сервис администрирования** (`admin`)

### Kafka
Кластер Kafka состоит из трёх нод и UI для управления:

1. **Kafka-0**  
   - Порты: 9092 (внутренний), 9094 (внешний)
   - Данные хранятся в томе `kafka-0_data`
   - Автоматическая проверка состояния

2. **Kafka-1**  
   - Порты: 9092, 9095
   - Данные сохраняются в `kafka-1_data`
   - Поддержка отказоустойчивости

3. **Kafka-2**  
   - Порты: 9092, 9096
   - Данные хранятся в томе `kafka-2_data`

4. **Kafka-UI**  
   Предоставляет веб-интерфейс для управления топиками, брокерами и сообщениям.

### ClickHouse
- Колонночная база данных для аналитики
- Опционально доступен через порт 8123

### UGC сервис
Сервис реализован на FastAPI. Для идентификации пользователя сервис декодирует JWT токен, полученный с запроса (API Gateway).
Содержит один запрос `ugc/api/v1/produce/send_to_broker/{event_type}`, который валидирует и форматирует данные для последующей отправки в Kafka.

### Сервис аутентификации

[Импортирован с предыдущего спринта](https://github.com/Benrise/Auth_sprint_2)

### Сервис выдачи контента

[Импортирован с предыдущего спринта](https://github.com/Benrise/Async_API_sprint_2)

## Настройка переменных окружения

Все микросервисы управляются центральным `.env` файлом, который должен быть заполнен перед запуском.
Пример `.env` файла представлен в `.env.example`.

### Примечание

- Убедитесь, что **все** переменные окружения указаны в `.env` файле. 
- Лишних переменных окружения нет.
- Если какая-либо переменная отсутствует или неправильно настроена, система не запустится.

## Первый холодный запуск системы
`
docker compose up --build -d
`

После холодного запуска системы необходимо вручную выполнить команды, описанные в entry-point.sh файлах сервисов Admin и Auth.

- Для сервиса Admin:

```
python manage.py check --deploy

python manage.py migrate --no-input

python manage.py createsuperuser --no-input \
    --username $ADMIN_DJANGO_SUPERUSER_USERNAME \
    --email $ADMIN_DJANGO_SUPERUSER_EMAIL

python manage.py collectstatic --no-input
```
- Для сервиса Auth:

```
alembic upgrade head

python create_roles.py

python create_superuser.py $AUTH_SUPERUSER_USERNAME $AUTH_SUPERUSER_PASSWORD
```

Последующие миграции для сервисов выполняются вручную.
Таблицы для Clickhouse создаются автоматически при каждом запуске сервиса.

## Документация

После запуска системы документация API будет доступна по следующим ссылкам:

http://localhost/movies/api/v1/docs — Сервис выдачи контента
http://localhost/ugc/api/v1/docs — Сервис регистрации пользовательских событий
http://localhost/auth/api/v1/docs — Сервис авторизации
http://localhost/admin/api/v1/docs  — Сервис администрирования

*[!] Чтобы получить доступ ко всем сервисам (movies, ugc, admin), необходимо авторизоваться [!]*
